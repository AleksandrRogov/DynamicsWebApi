<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <style>
        button {
            display: block;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <h3>DynamicsWebApi Callbacks</h3>
    <button onclick="CreateRecord()">Create Record</button>
    <button onclick="UpdateRecord()">Update Record</button>
    <button onclick="UpdateRequest()">Update Request</button>
    <button onclick="UpdateSingleProperty()">Update Single Property</button>
    <button onclick="RetrieveRecord()">Retrieve Record</button>
    <button onclick="RetrieveReference()">Retrieve Record Reference</button>
    <button onclick="RetrieveRelated()">Retrieve Related Record</button>
    <button onclick="RetrieveRequest()">Retrieve Request</button>
    <button onclick="RetrieveReferenceRequest()">Retrieve Reference Request</button>
    <button onclick="RetrieveRelatedRequest()">Retrieve Related Record Request</button>
    <button onclick="CountRecords()">Count Records</button>
    <button onclick="DeleteRecord()">Delete Record</button>
    <button onclick="DeleteRequest()">Delete Request</button>
    <button onclick="UpsertRecord()">Upsert Record</button>
    <button onclick="UpsertRequest()">Upsert Request</button>
    <button onclick="RetrieveMultipleRecordsExtended()">Multiple Records Extended</button>
    <button onclick="RetrieveMultiplePaging()">Multiple Paging</button>
    <button onclick="FetchXmlTest()">Fetch XML Test</button>
    <button onclick="Associate()">Associate</button>
    <button onclick="AssociateSingleValued()">Associate Single Valued</button>
    <button onclick="Disassociate()">Disassociate</button>
    <button onclick="DisassociateSingleValued()">Disassociate Single Valued</button>
    <button onclick="ExecuteBoundFunction()">Bound Function</button>
    <button onclick="ExecuteUnboundFunction()">Unbound Function</button>
    <button onclick="ExecuteBoundAction()">Bound Action</button>
    <button onclick="ExecuteUnboundAction()">Unbound Action</button>
    <button onclick="TestAnotherInstance()">Another instance test</button>
    <button onclick="DeleteTestData()">Delete Test Data</button>

    <script src="../../clientGlobalcontext.js.aspx"></script>
    <script src="../Scripts/DynamicsWebApi.Callbacks.js"></script>
    <script>
        var recordId = "115a8970-d788-4bf6-b064-d1574dbe6930";
        var dynamicsWebApi = new DynamicsWebApi({ webApiVersion: "8.2" });
        var deleteTestObjects = [];
        var accountId = null;
        var testEntityid = null;
        var queueId = null;

        //for association
        dynamicsWebApi.retrieveMultiple("accounts", function (response) {
            /// <param name="response" type="DWA.Types.MultipleResponse">Response object</param>
            accountId = response.value[0].accountid;
        }, function (error) {
            debugger;
        }, ["accountid"], "name eq 'Best For You Organics Company'");

        dynamicsWebApi.create({ o4u_name: "Test" }, "o4u_tests", function (id) {
            testEntityid = id;
            deleteTestObjects.push({ id: id, type: "o4u_tests" });
        }, function (error) {
            debugger;
        });

        var suppressError = function () { };

        dynamicsWebApi.executeUnboundFunction("WhoAmI", function (response) {
            dynamicsWebApi.retrieve(response.UserId, "systemusers", function (response) {
                queueId = response._queueid_value;
            }, suppressError, ["_queueid_value"])
        }, suppressError);

        function CreateRecord() {
            var lead = {
                subject: "Test WebAPI",
                firstname: "Test",
                lastname: "WebAPI",
                jobtitle: "Title"
            };
            dynamicsWebApi.create(lead, "leads", function (id) {
                alert(id);
                recordId = id;
            }, function (error) {
                debugger;
            });
        }
        function RetrieveRecord() {
            dynamicsWebApi.retrieve(recordId, "leads", function (record) {
                var fullname = record.fullname;
                debugger;
            }, function (error) {
                //if the record has not been found it will throw an error
                debugger;
                console.trace(error.message);
            }, ["fullname", "subject"]);
        }
        function RetrieveReference() {
            dynamicsWebApi.retrieve(recordId, "leads", function (reference) {
                /// <param name="reference" type="DWA.Types.ReferenceResponse">Response</param>
                alert(reference.id + " " + reference.collection);
            }, function (error) {
                //if the record has not been found it will throw an error
                debugger;
                console.trace(error.message);
            }, ["ownerid/$ref"]);
        }
        function RetrieveRelated() {
            dynamicsWebApi.retrieve(testEntityid, "o4u_tests", function (response) {
                alert(response.subject + ": " + response.fullname);
            }, function (error) {
                debugger;
                console.trace(error.message);
            }, ["/o4u_LeadTest", "fullname", "subject"]);
        }
        function RetrieveRequest() {
            var request = {
                id: recordId,
                collection: "leads",
                select: ["fullname", "subject"],

                //ETag value with the If-None-Match header to request data to be retrieved only if it has changed since the last time it was retrieved
                ifnonematch: 'W/"468026"'
            };

            dynamicsWebApi.retrieveRequest(request, function (response) {
                alert(response.subject);
            }, function (error) {
                //if the record has not been found it will throw an error
                debugger;
                console.trace(error.message);
            });
        }
        function RetrieveReferenceRequest() {
            var request = {
                id: recordId,
                collection: "leads",
                select: ["ownerid/$ref"]
            };
            dynamicsWebApi.retrieveRequest(request, function (reference) {
                /// <param name="reference" type="DWA.Types.ReferenceResponse">Response</param>
                alert(reference.id + " " + reference.collection);
            }, function (error) {
                //if the record has not been found it will throw an error
                debugger;
                console.trace(error.message);
            });
        }
        function RetrieveRelatedRequest() {
            var request = {
                id: testEntityid,
                collection: "o4u_tests",
                navigationProperty: "o4u_LeadTest", //use request.navigationProperty
                select: ["fullname", "subject"]
            }

            //or

            //request = {
            //    id: testEntityid,
            //    collection: "o4u_tests",
            //    select: ["/o4u_LeadTest", "fullname", "subject"]    //or inline with prefix "/"
            //}

            dynamicsWebApi.retrieveRequest(request, function (response) {
                alert(response.subject + ": " + response.fullname);
            }, function (error) {
                debugger;
            });
        }
        function CountRecords() {
            dynamicsWebApi.count("leads", function (count) {
                alert(count);
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function RetrieveMultipleRecordsExtended() {
            var request = {
                collection: "leads",
                select: ["fullname", "subject"],
                filter: "leadid eq " + recordId,
                maxPageSize: 1
            };

            dynamicsWebApi.retrieveMultipleRequest(request,
                function (response) {
                    /// <param name="response" type="DWA.Types.MultipleResponse">Request response</param>

                    //get a field value here (check first whether object (array) contains any element)
                    var fullname = response.value.length ? response.value[0].fullname : "-1";
                    debugger;
                }, function (error) {
                    debugger;
                    console.trace(error.message);
                });
        }
        function RetrieveMultiplePaging() {
            var request = {
                collection: "leads",
                select: ["firstname", "subject"],
                maxPageSize: 5
            };

            dynamicsWebApi.retrieveMultipleRequest(request, function (response) {
                /// <param name="response" type="DWA.Types.MultipleResponse">Request response</param>

                debugger;

                return dynamicsWebApi.retrieveMultipleRequest(request, function (response) {
                    /// <param name="response" type="DWA.Types.MultipleResponse">Request response</param>
                    debugger;
                }, function (error) {
                    debugger;
                    console.trace(error.message);
                }, response.oDataNextLink);
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function DeleteRecord() {
            dynamicsWebApi.deleteRecord(recordId, "leads", function () {
                alert("success!");
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function DeleteRequest() {
            //delete with optimistic concurrency
            var request = {
                id: recordId,
                collection: "leads",
                ifmatch: 'W/"470867"'
            }

            dynamicsWebApi.deleteRequest(request, function (isDeleted) {
                if (isDeleted) {
                    alert("success!");
                }
                else {
                    alert("precondition failed!");
                }
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function UpdateRequest() {
            var request = {
                id: recordId,
                collection: "leads",
                entity: {
                    subject: "Test update"
                },
                returnRepresentation: true
            };

            dynamicsWebApi.updateRequest(request, function (response) {
                alert(response.fullname);
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function UpdateRecord() {
            var lead = {
                subject: "Test update"
            }

            dynamicsWebApi.update(recordId, "leads", lead, function (response) {
                alert("updated!");
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function UpsertRecord() {
            var lead = {
                subject: "Upsert!!"
            };

            dynamicsWebApi.upsert(recordId, "leads", lead, function (id) {
                if (id != null) {
                    debugger;
                    recordId = id;
                }
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function UpsertRequest() {
            var request = {
                id: recordId,
                collection: "leads",
                returnRepresentation: true,
                select: ["fullname"],
                entity: {
                    subject: "Test upsert"
                },
                ifnonematch: "*" //to prevent update
            };

            dynamicsWebApi.upsertRequest(request, function (record) {
                if (record != null) {
                    alert(record.fullname);
                }
                else {
                    //update prevented
                }
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function UpdateSingleProperty() {
            dynamicsWebApi.updateSingleProperty(recordId, "leads", { subject: "Update Single" }, function () {
                alert("success!");
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function FetchXmlTest() {
            var fetchXml = "<fetch mapping='logical' count='5'>" +
                               "<entity name='account'>" +
                                  "<attribute name='accountid'/>" +
                                  "<attribute name='name'/>" +
                                "</entity>" +
                            "</fetch>";

            dynamicsWebApi.executeFetchXml("accounts", fetchXml, function (response) {
                /// <param name="response" type="DWA.Types.FetchXmlResponse">Request response</param>

                debugger;

                dynamicsWebApi.executeFetchXml("accounts", fetchXml, function (response) {
                    debugger;
                }, function (error) {

                }, null, response.PagingInfo.nextPage, response.PagingInfo.cookie);
            }, function (error) {
                debugger;
                console.trace(error.message);
            })
        }
        function Associate() {
            dynamicsWebApi.associate("accounts", accountId, "lead_parent_account", "leads", recordId, function () {
                alert("success!");
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function Disassociate() {
            dynamicsWebApi.disassociate("accounts", accountId, "lead_parent_account", recordId, function () {
                alert("success!");
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function AssociateSingleValued() {
            dynamicsWebApi.associateSingleValued("o4u_tests", testEntityid, "o4u_LeadTest", "leads", recordId, function () {
                alert("success!");
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function DisassociateSingleValued() {
            dynamicsWebApi.disassociateSingleValued("o4u_tests", testEntityid, "o4u_LeadTest", function () {
                alert("success!");
            }, function (error) {
                debugger;
                console.trace(error.message);
            });
        }
        function ExecuteBoundFunction() {
            dynamicsWebApi.retrieveMultiple("teams", function (response) {
                /// <param name="response" type="DWA.Types.MultipleResponse">Response</param>

                dynamicsWebApi.executeBoundFunction(response.value[0].teamid, "teams", "Microsoft.Dynamics.CRM.RetrieveTeamPrivileges", function (response) {
                    debugger;
                }, function (error) {
                    debugger;
                })
            }, function (error) {
                debugger;
            });
        }
        function ExecuteUnboundFunction() {
            var parameters = {
                LocalizedStandardName: 'Pacific Standard Time',
                LocaleId: 1033
            };
            dynamicsWebApi.executeUnboundFunction("GetTimeZoneCodeByLocalizedName", function (result) {
                alert(result.TimeZoneCode);
            }, function (error) {
                debugger;
                console.trace(error.message);
            }, parameters);
        }
        function ExecuteUnboundAction() {
            var createOpp = { name: "test" };
            dynamicsWebApi.create(createOpp, "opportunities", function (opportunityId) {
                deleteTestObjects.push({ id: opportunityId, type: "opportunities" });
                var actionRequest = {
                    Status: 3,
                    OpportunityClose: {
                        subject: "Won Opportunity",
                        "opportunityid@odata.bind": "opportunities(" + opportunityId + ")"
                    }
                };
                dynamicsWebApi.executeUnboundAction("WinOpportunity", actionRequest, function () {
                    alert("WON!");
                }, suppressError);
            }, suppressError);
        }
        function ExecuteBoundAction() {
            dynamicsWebApi.create({ subject: "test" }, "letters", function (letterActivityId) {
                var actionRequest = {
                    Target: {
                        activityid: letterActivityId,
                        "@odata.type": "Microsoft.Dynamics.CRM.letter"
                    }
                };
                deleteTestObjects.push({ id: letterActivityId, type: "letters" });

                dynamicsWebApi.executeBoundAction(queueId, "queues", "Microsoft.Dynamics.CRM.AddToQueue", actionRequest, function (response) {
                    alert(response.QueueItemId);
                }, suppressError);
            }, suppressError);
        }
        function TestAnotherInstance() {

            var instance = dynamicsWebApi.initializeInstance({ webApiVersion: "8.0" });

            instance.count("accounts", function (count) {
                alert(count);
            }, function (error) {
                debugger;
                console.trace(error.message);
            })
        }
        function DeleteTestData() {
            var length = deleteTestObjects.length;
            for (var i = 0; i < length; i++) {
                var deleteObject = deleteTestObjects.pop();
                dynamicsWebApi.deleteRecord(deleteObject.id, deleteObject.type, function () {
                    alert("success!");
                }, function (error) {
                    debugger;
                });
            }
        }
    </script>
</body>

</html>
